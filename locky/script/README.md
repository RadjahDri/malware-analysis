# C&C
## Pincipe
Le script cac.py permet de simuler l'activité d'un C&C à travers les communications avec Locky. Actuellement seul deux types de réponses sur trois sont implémentés, les fournitures de la clé de chiffrement et du texte de rançon.

## Architecture logiciel
Le script de C&C se compose de deux services:
- Un serveur DNS répondant aux demandes pour les domaines générés par le DGA
- Le C&C lui même

### Serveur DNS
Le serveur DNS sert à rediriger les requêtes du malware vers le C&C qui est situé sur le même poste. Pour capter les requêtes DNS, il est nécessaire de configurer le poste où est lancé le script comme serveur DNS principal du poste d'analyse où est lancé le malware.

### C&C
Le C&C écoute le port HTTP et traite les requêtes du malware. Deux types de requêtes sont traités:
- getkey: Locky demande la clé publique qui sert lors du chiffrement des données. Le C&C renvoit toujours la même clé qui est stockée en dur.
- gettext: Locky demande le texte d'explication à l'utilisateur et qui annoce le moyen de payer la rançon.

## Utilisation
### Prérequis
Tout d'abord, le script demande:
- python3.6
- La bibliothèque dnslib
- Des scripts développés lors de cette analyse:
  - dgaV2
  - dns
  - lockyHTTPRequestCipher
  - lockyHTTPResponseCipher

### Mise en place
Il vous faut deux postes (physique ou virtuel),
l'un ou sera exécuté Locky (Client) et l'autre qui servira de C&C/DNS (Server). N'oubliez pas que le but de Locky est de chiffrer votre PC, faites gaffe à ce que vous utilisez comme Client.SURTOUT PRENEZ GARDE A VOS DOSSIERS PARTAGES ! par exemple, mettez en place une VM sous Virtualbox avec un snapshot.

Configuré le Client pour utiliser le Server comme DNS.

### Lancement
Le script de C&C n'utilise que deux arguments:
- -H, --host: Renseignez l'adresse IP de l'interface où Locky doit se connecter.
- -c, --config: Renseignez la constante de configuration de votre sample de Locky. Trouver cette information demande un peu d'analyse technique.

Ce qui donne dans mon cas:
```
python3.6 cac.py -H 192.168.56.1 -c 7
```

Sur le Client exécutez le sample de Locky soit:
- Librement si votre but est d'observer les résultats
- Dans une sandbox pour observer les ressources utilisés
- Dans un débugger pour observer le fonctionnement du malware
