#!/usr/bin/python

import sys,md5

def ror(n, dec):
    n &= 0xFFFFFFFF
    return ((n >> dec) | (n << (32-dec))) & 0xFFFFFFFF

def rol(n, dec):
    return ((n << dec) | (n >> (32-dec))) & 0xFFFFFFFF

if(len(sys.argv) != 2):
	print "Usage: "+sys.argv[0]+" plaintext"
	exit(0)

plaintext = sys.argv[1]

m = md5.new()
m.update(plaintext)
m.digest()
md5 = m.digest()

#data = map(ord, "\x56\x73\x41\x35\xc7\xe1\x40\x12\x8d\x8f\x76\x33\x92\x21\x54\x65id=D409D36E329200D1&act=getkey&affid=3&lang=fr&corp=0&serv=0&os=Windows+7&sp=1&x64=1")

data = map(ord, md5+plaintext)

key = 0xCD43EF19
for i in range(len(data)):
	currentChar = data[i]
	#Erreur
	data[i] = (((ror(key, 5) & 0xFF) - rol(i, 0xD) & 0xFF) & 0xFF) ^ (data[i] & 0xFF)
	key = (rol(currentChar, i%32) + ror(key,1)) ^ (ror(i, 23) + 0x53702F68)

print "".join(map(lambda x: x[2:],map(hex,data)))
