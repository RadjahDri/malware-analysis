import sys, argparse, datetime

#
# DGA from Locky sample 45f4c705c8f4351e925aea2eb0a7f564
# Locky's DGA version 2
# Author: Adrien Coueron
#

def ror(n, dec):
    n &= BIG_INT
    return ((n >> dec) | (n << (32-dec))) & BIG_INT

def rol(n, dec):
    return ((n << dec) | (n >> (32-dec))) & BIG_INT

if __name__ == "__main__":
	parser = argparse.ArgumentParser()
	parser.add_argument("-d", "--date",
      help="Date pour laquelle les domaines doivent etre generes")
	parser.add_argument("-c", "--config",
      type=int, help="Configuration du DGA")
	args = parser.parse_args()

	if args.date:
		d = datetime.datetime.strptime(args.date, "%d/%m/%Y")
	else:
		d = datetime.datetime.now()
	if args.config:
		dgaConfiguration = args.config
	else:
		dgaConfiguration = 7

	BIG_INT = 0xFFFFFFFF

	day = d.day
	year = d.year
	month = d.month
	tld = ['ru', 'pw', 'eu', 'in', 'yt', 'pm', 'us',
      'fr', 'de', 'it', 'be', 'uk', 'nl', 'tf']

	#Generation des 6 domaines pour la date donnee
	for n in range(8):
		#Traitement sur les donnees de date et de configuration
		valueComputed = ((ror(((((((ror(((((ror(((((ror((((ror(
			((year + 0x1BF5) * 0xB11924E1) & BIG_INT, 7) + 
			dgaConfiguration + 0x27100001) & BIG_INT) * 0xB11924E1) 
			& BIG_INT, 7)) + (day >> 1) + 0x27100001) & BIG_INT) * 
			0xB11924E1) & BIG_INT, 7)) + month + 0x2709A354) & BIG_INT) *
			0xB11924E1) & BIG_INT, 7) + rol(n & 7, 0x15)) & BIG_INT) +
			rol(dgaConfiguration, 0x11) + 0x27100001) & BIG_INT) * 
  0xB11924E1) & BIG_INT), 7)) + 0x27100001) & BIG_INT
		###
		#Choix de la longueur du nom de domaine
		lengthDomainNamePrefix = (valueComputed % 11) + 5
		###
		#Generation de chaque caractere
		domain = ""
		for i in range(lengthDomainNamePrefix):
			valueComputed = (ror((rol(valueComputed, i) * 0xB11924E1) & BIG_INT, 7) + 0x27100001) & BIG_INT
			domain += chr((valueComputed % 25) + ord('a'))
		###
		#Ajout du TLD
		domain += '.'
		domain += tld[((ror((valueComputed * 0xB11924E1) & BIG_INT, 7) + 0x27100001) & BIG_INT) % 14]
		###
		print domain
